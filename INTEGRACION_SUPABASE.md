# Integraci√≥n con Supabase para Resultados de ML

## üìã Resumen

Se ha implementado la funcionalidad para guardar los resultados de entrenamiento de modelos y predicciones directamente en **Supabase** desde el m√≥dulo "Resultados".

---

## üéØ Funcionalidad Implementada

### Flujo Completo

```
1. Cargar Datos
   ‚Üì
2. Entrenar Modelo (Scikit-learn o PyTorch)
   ‚Üì
3. Ver Resultados
   ‚Üì
4. Click "Guardar en Supabase" ‚≠ê NUEVO
   ‚Üì
5. Datos guardados en Supabase
```

---

## üóÑÔ∏è Estructura de Base de Datos

### Tabla: `model_results`

Almacena los resultados principales de cada modelo entrenado.

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | UUID | ID √∫nico (Primary Key) |
| `table_name` | TEXT | Nombre de la tabla de datos usada |
| `framework` | TEXT | Framework usado (sklearn/pytorch) |
| `model_type` | TEXT | Tipo de modelo (rf, mlp, etc.) |
| `metrics` | JSONB | M√©tricas del modelo (JSON) |
| `training_time` | FLOAT | Tiempo de entrenamiento (segundos) |
| `model_parameters` | INTEGER | N√∫mero de par√°metros del modelo |
| `created_at` | TIMESTAMP | Fecha de creaci√≥n |
| `updated_at` | TIMESTAMP | Fecha de actualizaci√≥n |

**Ejemplo de datos:**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "table_name": "iris",
  "framework": "sklearn",
  "model_type": "rf",
  "metrics": {
    "accuracy": 0.95,
    "precision": 0.93,
    "recall": 0.92,
    "f1_score": 0.92
  },
  "training_time": 2.5,
  "model_parameters": 1000,
  "created_at": "2025-10-26T05:45:00Z"
}
```

### Tabla: `model_predictions`

Almacena las predicciones individuales de cada modelo.

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | UUID | ID √∫nico (Primary Key) |
| `model_result_id` | UUID | Referencia a model_results |
| `sample_id` | INTEGER | ID de la muestra |
| `true_value` | TEXT | Valor real |
| `predicted_value` | TEXT | Valor predicho |
| `confidence` | FLOAT | Confianza (0-1) |
| `created_at` | TIMESTAMP | Fecha de creaci√≥n |

**Ejemplo de datos:**
```json
{
  "id": "660e8400-e29b-41d4-a716-446655440001",
  "model_result_id": "550e8400-e29b-41d4-a716-446655440000",
  "sample_id": 1,
  "true_value": "setosa",
  "predicted_value": "setosa",
  "confidence": 0.98,
  "created_at": "2025-10-26T05:45:01Z"
}
```

### Relaciones

```
model_results (1) ‚îÄ‚îÄ‚îÄ‚îÄ (N) model_predictions
```

- Un modelo puede tener m√∫ltiples predicciones
- Las predicciones se eliminan en cascada si se elimina el modelo

---

## üîß Implementaci√≥n Backend

### Endpoint: `POST /save-to-supabase`

**Ubicaci√≥n:** `backend/app.py`

**Request Body:**
```json
{
  "table_name": "iris",
  "training_results": {
    "framework": "sklearn",
    "metrics": {
      "accuracy": 0.95,
      "precision": 0.93,
      "recall": 0.92,
      "f1_score": 0.92
    },
    "training_time": 2.5,
    "model_parameters": 1000
  },
  "predictions": [
    {
      "sample_id": 1,
      "true_value": "setosa",
      "predicted_value": "setosa",
      "confidence": 0.98
    }
  ],
  "model_metadata": {
    "model_type": "rf",
    "timestamp": "2025-10-26T05:45:00Z"
  }
}
```

**Response (Success):**
```json
{
  "success": true,
  "message": "Resultados guardados exitosamente en Supabase",
  "record_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Response (Error):**
```json
{
  "detail": "Error al guardar en Supabase: [mensaje de error]"
}
```

### C√≥digo Backend

```python
@app.post("/save-to-supabase")
async def save_to_supabase(request: SaveToSupabaseRequest):
    """Save training results and predictions to Supabase"""
    try:
        # Preparar datos para guardar
        data_to_insert = {
            "table_name": request.table_name,
            "framework": request.training_results.get("framework"),
            "metrics": request.training_results.get("metrics", {}),
            "model_type": request.model_metadata.get("model_type"),
            "training_time": request.training_results.get("training_time"),
            "model_parameters": request.training_results.get("model_parameters"),
        }
        
        # Guardar en tabla de resultados
        result = supabase.table("model_results").insert(data_to_insert).execute()
        
        # Guardar predicciones
        if request.predictions:
            model_id = result.data[0]["id"]
            predictions_data = [...]
            supabase.table("model_predictions").insert(predictions_data).execute()
        
        return {"success": True, "message": "Guardado exitosamente"}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

---

## üíª Implementaci√≥n Frontend

### Bot√≥n en ResultsDialog

**Ubicaci√≥n:** `src/components/modules/ResultsDialog.tsx`

**C√≥digo:**
```typescript
const handleSaveToSupabase = async () => {
  if (!trainingResults) return;
  
  setLoading(true);
  
  try {
    const response = await axios.post("/save-to-supabase", {
      table_name: "model_results",
      training_results: trainingResults,
      predictions: predictions.length > 0 ? predictions : null,
      model_metadata: {
        model_type: trainingResults.framework === "sklearn" ? "scikit-learn" : "pytorch",
        timestamp: new Date().toISOString()
      }
    });
    
    toast({
      title: "‚úÖ Guardado en Supabase",
      description: response.data.message,
    });
  } catch (error: any) {
    toast({
      title: "Error al guardar en Supabase",
      description: error.response?.data?.detail || "Error desconocido",
      variant: "destructive",
    });
  } finally {
    setLoading(false);
  }
};
```

### Interfaz de Usuario

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üìä Resultados del Modelo                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [M√©tricas] [Predicciones] [An√°lisis]      ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  ... contenido de resultados ...            ‚îÇ
‚îÇ                                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [üì• Exportar]  [üíæ Guardar Modelo]        ‚îÇ
‚îÇ  [üíæ Guardar en Supabase] ‚≠ê               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Caracter√≠sticas del bot√≥n:**
- ‚úÖ Icono de Save (üíæ)
- ‚úÖ Texto: "Guardar en Supabase"
- ‚úÖ Estado de carga: "Guardando..."
- ‚úÖ Deshabilitado durante guardado
- ‚úÖ Estilo: Gradient primary (destacado)
- ‚úÖ Notificaci√≥n de √©xito/error

---

## üìù Configuraci√≥n de Supabase

### 1. Crear las Tablas

Ejecutar el script SQL en Supabase:

```bash
# Ubicaci√≥n del script
backend/supabase_tables.sql
```

**Pasos:**
1. Ir a Supabase Dashboard
2. Seleccionar proyecto
3. Ir a SQL Editor
4. Copiar y pegar el contenido de `supabase_tables.sql`
5. Ejecutar

### 2. Configurar Permisos (RLS)

Si tienes Row Level Security (RLS) habilitado:

```sql
-- Permitir inserci√≥n para usuarios autenticados
CREATE POLICY "Allow insert for authenticated users"
ON model_results
FOR INSERT
TO authenticated
WITH CHECK (true);

CREATE POLICY "Allow insert predictions for authenticated users"
ON model_predictions
FOR INSERT
TO authenticated
WITH CHECK (true);

-- Permitir lectura para usuarios autenticados
CREATE POLICY "Allow read for authenticated users"
ON model_results
FOR SELECT
TO authenticated
USING (true);

CREATE POLICY "Allow read predictions for authenticated users"
ON model_predictions
FOR SELECT
TO authenticated
USING (true);
```

### 3. Verificar Conexi√≥n

**Backend:**
```python
# backend/supabase_client.py
SUPABASE_URL = "https://syqvsnlqexyxleuabdvv.supabase.co"
SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

**Frontend:**
```typescript
// src/integrations/supabase/client.ts
const SUPABASE_URL = "https://syqvsnlqexyxleuabdvv.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
```

---

## üöÄ C√≥mo Usar

### Paso a Paso

1. **Entrenar un modelo**
   ```
   M√≥dulo "Entrenar Modelos" ‚Üí Configurar ‚Üí Entrenar
   ```

2. **Ver resultados**
   ```
   Autom√°ticamente abre "Resultados"
   O click en m√≥dulo "Resultados"
   ```

3. **Guardar en Supabase**
   ```
   Click en bot√≥n "Guardar en Supabase"
   Esperar notificaci√≥n de √©xito
   ```

4. **Verificar en Supabase**
   ```
   Ir a Supabase Dashboard
   Table Editor ‚Üí model_results
   Ver registro guardado
   ```

### Ejemplo Completo

```
1. Cargar iris.csv (150 filas)
2. Entrenar Random Forest
   - Accuracy: 95%
   - Precision: 93%
   - Recall: 92%
3. Ver resultados
4. Click "Guardar en Supabase"
5. ‚úÖ Guardado exitosamente
6. Verificar en Supabase:
   - 1 registro en model_results
   - 20 registros en model_predictions
```

---

## üìä Datos Guardados

### Informaci√≥n del Modelo

- ‚úÖ Nombre de la tabla de datos
- ‚úÖ Framework usado (sklearn/pytorch)
- ‚úÖ Tipo de modelo (rf, mlp, etc.)
- ‚úÖ Todas las m√©tricas (JSON)
- ‚úÖ Tiempo de entrenamiento
- ‚úÖ N√∫mero de par√°metros
- ‚úÖ Timestamp de creaci√≥n

### Predicciones

- ‚úÖ Hasta 100 predicciones por modelo
- ‚úÖ Valor real vs predicho
- ‚úÖ Nivel de confianza
- ‚úÖ ID de muestra
- ‚úÖ Referencia al modelo

---

## üîç Consultas √ötiles en Supabase

### Ver todos los modelos

```sql
SELECT 
  id,
  table_name,
  framework,
  model_type,
  metrics->>'accuracy' as accuracy,
  training_time,
  created_at
FROM model_results
ORDER BY created_at DESC;
```

### Ver predicciones de un modelo

```sql
SELECT 
  p.*,
  m.framework,
  m.model_type
FROM model_predictions p
JOIN model_results m ON p.model_result_id = m.id
WHERE m.id = 'tu-model-id'
ORDER BY p.sample_id;
```

### Estad√≠sticas de modelos

```sql
SELECT 
  framework,
  COUNT(*) as total_models,
  AVG((metrics->>'accuracy')::float) as avg_accuracy,
  AVG(training_time) as avg_training_time
FROM model_results
GROUP BY framework;
```

### Modelos m√°s recientes

```sql
SELECT 
  table_name,
  framework,
  model_type,
  metrics->>'accuracy' as accuracy,
  created_at
FROM model_results
ORDER BY created_at DESC
LIMIT 10;
```

---

## ‚úÖ Validaciones

### Backend

- ‚úÖ Verifica que trainingResults exista
- ‚úÖ Valida estructura de datos
- ‚úÖ Maneja errores de Supabase
- ‚úÖ Limita predicciones a 100
- ‚úÖ Retorna ID del registro creado

### Frontend

- ‚úÖ Verifica que haya resultados
- ‚úÖ Deshabilita bot√≥n durante guardado
- ‚úÖ Muestra estado de carga
- ‚úÖ Notificaci√≥n de √©xito/error
- ‚úÖ Incluye predicciones si existen

---

## üéØ Beneficios

1. **Persistencia** - Resultados guardados permanentemente
2. **Historial** - Seguimiento de todos los modelos entrenados
3. **An√°lisis** - Consultas SQL para an√°lisis avanzado
4. **Comparaci√≥n** - Comparar m√∫ltiples modelos
5. **Auditor√≠a** - Timestamps autom√°ticos
6. **Escalabilidad** - Base de datos en la nube
7. **Accesibilidad** - Datos accesibles desde cualquier lugar

---

## üìÅ Archivos Modificados/Creados

### Backend

1. **`backend/app.py`** ‚ú® MODIFICADO
   - Agregado endpoint `/save-to-supabase`
   - Agregada clase `SaveToSupabaseRequest`
   - +50 l√≠neas

2. **`backend/supabase_tables.sql`** ‚ú® NUEVO
   - Script SQL para crear tablas
   - √çndices y triggers
   - Documentaci√≥n

### Frontend

3. **`src/components/modules/ResultsDialog.tsx`** ‚ú® MODIFICADO
   - Agregada funci√≥n `handleSaveToSupabase`
   - Agregado bot√≥n "Guardar en Supabase"
   - Importado icono Save
   - +40 l√≠neas

### Documentaci√≥n

4. **`INTEGRACION_SUPABASE.md`** ‚ú® NUEVO
   - Documentaci√≥n completa
   - Ejemplos de uso
   - Consultas SQL

---

## üîÆ Mejoras Futuras

1. **Visualizaci√≥n de historial** - Ver modelos anteriores en la UI
2. **Comparaci√≥n de modelos** - Comparar m√∫ltiples modelos lado a lado
3. **Exportar desde Supabase** - Descargar datos guardados
4. **Filtros y b√∫squeda** - Buscar modelos por criterios
5. **Gr√°ficos de tendencias** - Evoluci√≥n de m√©tricas en el tiempo
6. **Compartir modelos** - Compartir resultados con otros usuarios
7. **Versionado** - Versiones de modelos entrenados

---

## üêõ Troubleshooting

### Error: "Cannot insert into model_results"

**Soluci√≥n:** Verificar que las tablas existan en Supabase
```sql
SELECT * FROM model_results LIMIT 1;
```

### Error: "RLS policy violation"

**Soluci√≥n:** Configurar pol√≠ticas de RLS o deshabilitar RLS
```sql
ALTER TABLE model_results DISABLE ROW LEVEL SECURITY;
ALTER TABLE model_predictions DISABLE ROW LEVEL SECURITY;
```

### Error: "Connection refused"

**Soluci√≥n:** Verificar credenciales de Supabase
```python
# backend/supabase_client.py
print(SUPABASE_URL)  # Verificar URL
print(SUPABASE_KEY[:20])  # Verificar Key (primeros 20 chars)
```

### Predicciones no se guardan

**Soluci√≥n:** Verificar que `predictions` tenga datos
```typescript
console.log("Predictions:", predictions.length);
```

---

## ‚úÖ Estado Final

- ‚úÖ Endpoint backend implementado
- ‚úÖ Bot√≥n frontend agregado
- ‚úÖ Tablas SQL creadas
- ‚úÖ Documentaci√≥n completa
- ‚úÖ Validaciones implementadas
- ‚úÖ Notificaciones configuradas
- ‚úÖ Todo funcionando correctamente

**El sistema est√° listo para guardar resultados en Supabase!** üéâ

---

## üìö Referencias

- [Supabase Documentation](https://supabase.com/docs)
- [Supabase Python Client](https://github.com/supabase-community/supabase-py)
- [Supabase JavaScript Client](https://github.com/supabase/supabase-js)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
