# Fix: Estad√≠sticas de Duplicados en M√≥dulo "Cargar Datos"

## üéØ Problema Identificado

El m√≥dulo "Cargar Datos" mostraba estad√≠sticas de los datos cargados (filas, columnas, nulos, duplicados, inconsistencias), pero la funci√≥n `calculateDuplicates()` **no estaba usando la l√≥gica mejorada** que ignora columnas de ID.

---

## üêõ Problema

### Funci√≥n Anterior

```typescript
const calculateDuplicates = (data: any[]) => {
  const seen = new Set();
  let duplicates = 0;
  
  data.forEach(row => {
    const rowString = JSON.stringify(row);  // ‚ùå Incluye TODAS las columnas (incluso ID)
    if (seen.has(rowString)) {
      duplicates++;
    } else {
      seen.add(rowString);
    }
  });
  
  return duplicates;
};
```

**Problemas:**
- ‚ùå Usa `JSON.stringify(row)` que incluye **todas las columnas**
- ‚ùå No ignora columnas de ID
- ‚ùå Detecta menos duplicados de los que realmente hay
- ‚ùå Inconsistente con el m√≥dulo "Limpiar Datos"

### Ejemplo del Problema

**Datos:**
```csv
id,nombre,edad,ciudad
1,Juan,25,Madrid
2,Mar√≠a,30,Barcelona
3,Juan,25,Madrid      ‚Üê Deber√≠a ser duplicado
```

**Detecci√≥n anterior:**
```typescript
Fila 1: JSON.stringify({id: 1, nombre: "Juan", edad: 25, ciudad: "Madrid"})
       = '{"id":1,"nombre":"Juan","edad":25,"ciudad":"Madrid"}'

Fila 3: JSON.stringify({id: 3, nombre: "Juan", edad: 25, ciudad: "Madrid"})
       = '{"id":3,"nombre":"Juan","edad":25,"ciudad":"Madrid"}'

Resultado: NO son duplicados ‚ùå (ID diferente)
```

---

## ‚úÖ Soluci√≥n Implementada

### Nueva Funci√≥n

```typescript
const calculateDuplicates = (data: any[], columns: string[]) => {
  if (!data || data.length === 0) return 0;
  
  // 1. Identificar columnas que probablemente son IDs (para ignorarlas)
  const idColumns = columns.filter(col => {
    const colLower = col.toLowerCase();
    if (colLower === 'id' || colLower === '_id' || colLower === 'index' || 
        colLower === 'row_id' || colLower === 'pk' || colLower.endsWith('_id')) {
      // Verificar si es √∫nica (caracter√≠stica de un ID)
      const uniqueValues = new Set(data.map(r => r[col]));
      return uniqueValues.size === data.length;
    }
    return false;
  });
  
  // 2. Columnas a considerar para duplicados (todas excepto IDs)
  const columnsToCheck = columns.filter(col => !idColumns.includes(col));
  const finalColumns = columnsToCheck.length > 0 ? columnsToCheck : columns;
  
  // 3. Detectar duplicados
  const seen = new Set();
  let duplicates = 0;
  
  data.forEach(row => {
    // Crear clave usando solo columnas relevantes
    const rowKey = finalColumns
      .map(col => {
        const value = row[col];
        if (value === null || value === undefined || value === '') return 'NULL';
        if (typeof value === 'string') return value.trim().toLowerCase();
        return String(value);
      })
      .join('|');
    
    if (seen.has(rowKey)) {
      duplicates++;
    } else {
      seen.add(rowKey);
    }
  });
  
  return duplicates;
};
```

**Mejoras:**
- ‚úÖ Ignora autom√°ticamente columnas de ID
- ‚úÖ Normaliza valores (trim, lowercase)
- ‚úÖ Compara solo datos relevantes
- ‚úÖ Consistente con m√≥dulo "Limpiar Datos"

### Actualizaci√≥n de Llamadas

**Antes:**
```typescript
<Badge variant="destructive">{calculateDuplicates(csvData)}</Badge>
<Badge variant="destructive">{calculateDuplicates(tableData)}</Badge>
```

**Despu√©s:**
```typescript
<Badge variant="destructive">{calculateDuplicates(csvData, csvColumns)}</Badge>
<Badge variant="destructive">{calculateDuplicates(tableData, tableColumns)}</Badge>
```

---

## üìä Comparaci√≥n

### Ejemplo: CSV con Duplicados

**Datos:**
```csv
id,nombre,edad,ciudad,salario
1,Juan,25,Madrid,50000
2,Mar√≠a,30,Barcelona,60000
3,Juan,25,Madrid,50000      ‚Üê Duplicado de fila 1
4,Pedro,35,Sevilla,55000
5,Mar√≠a,30,Barcelona,60000   ‚Üê Duplicado de fila 2
```

### Antes ‚ùå

```
M√≥dulo "Cargar Datos":
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Estad√≠sticas del Dataset    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Filas: 5                    ‚îÇ
‚îÇ Columnas: 5                 ‚îÇ
‚îÇ Nulos: 0                    ‚îÇ
‚îÇ Duplicados: 0               ‚îÇ  ‚Üê ‚ùå Incorrecto
‚îÇ Inconsistencias: 0          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Raz√≥n: JSON.stringify incluye ID, por lo que no detecta duplicados
```

### Despu√©s ‚úÖ

```
M√≥dulo "Cargar Datos":
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Estad√≠sticas del Dataset    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Filas: 5                    ‚îÇ
‚îÇ Columnas: 5                 ‚îÇ
‚îÇ Nulos: 0                    ‚îÇ
‚îÇ Duplicados: 2               ‚îÇ  ‚Üê ‚úÖ Correcto
‚îÇ Inconsistencias: 0          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Raz√≥n: Ignora columna ID y detecta duplicados correctamente
```

---

## üß™ Ejemplos

### Ejemplo 1: CSV con ID Autoincremental

**Datos:**
```csv
id,producto,precio,stock
1,Laptop,1000,50
2,Mouse,20,100
3,Laptop,1000,50      ‚Üê Duplicado
4,Teclado,50,75
5,Mouse,20,100         ‚Üê Duplicado
```

**Detecci√≥n:**
```
Columnas ID detectadas: [id]
Columnas a comparar: [producto, precio, stock]

Duplicados encontrados: 2
‚Ä¢ Filas 1, 3 tienen los mismos datos
‚Ä¢ Filas 2, 5 tienen los mismos datos
```

**Estad√≠sticas mostradas:**
```
Filas: 5
Columnas: 4
Duplicados: 2 ‚úÖ
```

### Ejemplo 2: Tabla con M√∫ltiples IDs

**Datos:**
```csv
user_id,order_id,producto,cantidad,total
101,1001,Laptop,1,1000
102,1002,Mouse,2,40
103,1003,Laptop,1,1000    ‚Üê Duplicado
104,1004,Teclado,1,50
```

**Detecci√≥n:**
```
Columnas ID detectadas: [user_id, order_id]
Columnas a comparar: [producto, cantidad, total]

Duplicados encontrados: 1
‚Ä¢ Filas 1, 3 tienen los mismos datos
```

**Estad√≠sticas mostradas:**
```
Filas: 4
Columnas: 5
Duplicados: 1 ‚úÖ
```

### Ejemplo 3: Sin Columnas de ID

**Datos:**
```csv
nombre,edad,ciudad
Juan,25,Madrid
Mar√≠a,30,Barcelona
Juan,25,Madrid      ‚Üê Duplicado
```

**Detecci√≥n:**
```
Columnas ID detectadas: []
Columnas a comparar: [nombre, edad, ciudad] (todas)

Duplicados encontrados: 1
```

**Estad√≠sticas mostradas:**
```
Filas: 3
Columnas: 3
Duplicados: 1 ‚úÖ
```

---

## üé® Visualizaci√≥n en UI

### M√≥dulo "Cargar Datos" - Tab CSV

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üìä Estad√≠sticas del Dataset                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Filas: 150                    [150]        ‚îÇ
‚îÇ Columnas: 5                   [5]          ‚îÇ
‚îÇ Nulos: 12                     [12]         ‚îÇ
‚îÇ Duplicados: 8                 [8]  ‚Üê ‚úÖ    ‚îÇ
‚îÇ Inconsistencias: 5            [5]          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

[Ver Tabla Completa]  [Continuar a Limpiar Datos]
```

### M√≥dulo "Cargar Datos" - Tab Base de Datos

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üìä Estad√≠sticas de la Tabla: usuarios      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Filas: 10,000                 [10,000]     ‚îÇ
‚îÇ Columnas: 8                   [8]          ‚îÇ
‚îÇ Nulos: 245                    [245]        ‚îÇ
‚îÇ Duplicados: 32                [32]  ‚Üê ‚úÖ   ‚îÇ
‚îÇ Inconsistencias: 18           [18]         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

[Ver Tabla Completa]  [Continuar a Limpiar Datos]
```

---

## üíª C√≥digo Implementado

### Archivo: `src/components/modules/DataLoaderDialog.tsx`

**Funci√≥n actualizada (l√≠neas 233-278):**
```typescript
const calculateDuplicates = (data: any[], columns: string[]) => {
  if (!data || data.length === 0) return 0;
  
  // Identificar columnas que probablemente son IDs (para ignorarlas)
  const idColumns = columns.filter(col => {
    const colLower = col.toLowerCase();
    if (colLower === 'id' || colLower === '_id' || colLower === 'index' || 
        colLower === 'row_id' || colLower === 'pk' || colLower.endsWith('_id')) {
      const uniqueValues = new Set(data.map(r => r[col]));
      return uniqueValues.size === data.length;
    }
    return false;
  });
  
  // Columnas a considerar para duplicados (todas excepto IDs)
  const columnsToCheck = columns.filter(col => !idColumns.includes(col));
  const finalColumns = columnsToCheck.length > 0 ? columnsToCheck : columns;
  
  const seen = new Set();
  let duplicates = 0;
  
  data.forEach(row => {
    const rowKey = finalColumns
      .map(col => {
        const value = row[col];
        if (value === null || value === undefined || value === '') return 'NULL';
        if (typeof value === 'string') return value.trim().toLowerCase();
        return String(value);
      })
      .join('|');
    
    if (seen.has(rowKey)) {
      duplicates++;
    } else {
      seen.add(rowKey);
    }
  });
  
  return duplicates;
};
```

**Llamadas actualizadas:**

**CSV (l√≠nea 423):**
```typescript
<Badge variant="destructive">{calculateDuplicates(csvData, csvColumns)}</Badge>
```

**Base de Datos (l√≠nea 512):**
```typescript
<Badge variant="destructive">{calculateDuplicates(tableData, tableColumns)}</Badge>
```

---

## üìÅ Archivos Modificados

### `src/components/modules/DataLoaderDialog.tsx` ‚ú®

**Cambios:**

1. **Funci√≥n `calculateDuplicates` actualizada** (l√≠neas 233-278)
   - ‚úÖ Ahora recibe `columns` como segundo par√°metro
   - ‚úÖ Detecta y ignora columnas de ID autom√°ticamente
   - ‚úÖ Normaliza valores para comparaci√≥n
   - ‚úÖ Usa misma l√≥gica que m√≥dulo "Limpiar Datos"

2. **Llamadas actualizadas** (l√≠neas 423, 512)
   - ‚úÖ CSV: `calculateDuplicates(csvData, csvColumns)`
   - ‚úÖ BD: `calculateDuplicates(tableData, tableColumns)`

---

## ‚úÖ Beneficios

### 1. Consistencia
- ‚úÖ Misma l√≥gica en "Cargar Datos" y "Limpiar Datos"
- ‚úÖ Estad√≠sticas coinciden entre m√≥dulos
- ‚úÖ Usuario ve informaci√≥n precisa

### 2. Precisi√≥n
- ‚úÖ Detecta duplicados reales (ignora ID)
- ‚úÖ No cuenta como duplicados filas con solo ID diferente
- ‚úÖ Normaliza valores para mejor detecci√≥n

### 3. Transparencia
- ‚úÖ Usuario sabe cu√°ntos duplicados hay antes de limpiar
- ‚úÖ Puede decidir si necesita limpiar datos
- ‚úÖ Estad√≠sticas confiables

---

## üéØ Resultado Final

### Flujo Completo

```
1. Usuario carga CSV/Tabla
   ‚Üì
2. Sistema calcula estad√≠sticas
   ‚úÖ Filas totales
   ‚úÖ Columnas totales
   ‚úÖ Valores nulos
   ‚úÖ Duplicados (ignorando ID) ‚Üê Corregido
   ‚úÖ Inconsistencias
   ‚Üì
3. Muestra estad√≠sticas en UI
   ‚úÖ "Duplicados: 8"
   ‚Üì
4. Usuario ve informaci√≥n precisa
   ‚úÖ Sabe que hay 8 filas duplicadas
   ‚Üì
5. Usuario abre "Limpiar Datos"
   ‚úÖ Ve los mismos 8 duplicados
   ‚úÖ Consistencia entre m√≥dulos
```

### Comparaci√≥n de Estad√≠sticas

**Antes ‚ùå:**
```
M√≥dulo "Cargar Datos":    Duplicados: 0
M√≥dulo "Limpiar Datos":   Duplicados: 8
                          ‚Üë Inconsistencia
```

**Despu√©s ‚úÖ:**
```
M√≥dulo "Cargar Datos":    Duplicados: 8
M√≥dulo "Limpiar Datos":   Duplicados: 8
                          ‚Üë Consistente
```

---

**Las estad√≠sticas de duplicados en "Cargar Datos" ahora son precisas y consistentes!** üéâ

**Antes:** Detectaba 0 duplicados (incorrecto)  
**Ahora:** Detecta 8 duplicados (correcto) ‚úÖ
